# 构建阶段
FROM python:3.9-slim as builder

WORKDIR /install

COPY requirements.txt .

RUN pip config set global.index-url https://mirrors.aliyun.com/pypi/simple/ \
    && pip config set global.trusted-host mirrors.aliyun.com \
    && pip install --prefix=/install -r requirements.txt

# 运行阶段
FROM python:3.9-slim

WORKDIR /app

# 安装系统依赖
RUN apt-get update && apt-get install -y \
    ffmpeg \
    libsm6 \
    libxext6 \
    libgl1-mesa-glx \
    && rm -rf /var/lib/apt/lists/*

# 从构建阶段复制安装好的依赖
COPY --from=builder /install /usr/local

COPY src/ ./src/

RUN mkdir -p /app/tmp /app/logs /app/output/videos /app/output/previews

ENV PYTHONUNBUFFERED=1
ENV PYTHONPATH=/app/src
ENV PYTHONDONTWRITEBYTECODE=1

EXPOSE 17778

CMD ["python", "-m", "src.main"] 